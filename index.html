<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with ChatGPT</title>
    <style>
        #chatbot {
            max-width: 400px;
            margin: auto;
            border: 1px solid #ccc;
            padding: 20px;
        }

        #chatLog {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        #userInput {
            width: calc(100% - 60px);
        }

        #sendButton {
            width: 50px;
        }
    </style>
</head>
<body>
    <div id="chatbot">
        <div id="chatLog"></div>
        <input type="text" id="userInput" placeholder="Type a message...">
        <button id="sendButton">Send</button>
        <div id="loading" style="display:none;">Thinking...</div>
    </div>

    <script>
        document.getElementById('sendButton').addEventListener('click', async () => {
    console.log("Button Clicked!");  // Questo dovrebbe loggare un messaggio ogni volta che il pulsante viene cliccato
    
    const userInput = document.getElementById('userInput');
    const chatLog = document.getElementById('chatLog');
    const loading = document.getElementById('loading');
        
    const userMessage = userInput.value.trim(); // Aggiunto trim() per rimuovere spazi iniziali/finali
        
    // Controllo se il messaggio non è vuoto
    if(userMessage) {
        chatLog.innerHTML += `<p>You: ${userMessage}</p>`;
        userInput.value = '';
            
        // Mostra l'indicatore di caricamento
        loading.style.display = 'block';
            
        try {
            const botResponse = await sendMessageToBot(userMessage);
            chatLog.innerHTML += `<p>Bot: ${botResponse}</p>`; // Assicurati che botResponse sia una stringa
        } catch (error) {
            chatLog.innerHTML += `<p>Bot: Sorry, I am unable to respond at the moment.</p>`;
        } finally {
            // Nascondi l'indicatore di caricamento
            loading.style.display = 'none';
            // Scorri il log della chat verso il basso per mostrare l'ultimo messaggio
            chatLog.scrollTop = chatLog.scrollHeight;
        }
    }
});

        async function sendMessageToBot(message) {
            const functionUrl = 'https://europe-west8-chatbot-test-399410.cloudfunctions.net/chatbot'; 
            
            try {
                const response = await fetch(functionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ prompt: message }),
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.statusText);
                }

                const data = await response.json();
                return data; // Assicurati che data sia una stringa o accedi alla proprietà corretta
            } catch (error) {
                console.error('Error:', error);
                throw error;
            }
        }
    </script>
</body>
</html>
